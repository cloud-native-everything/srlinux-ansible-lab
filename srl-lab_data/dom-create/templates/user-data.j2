#cloud-config
# Hostname management
preserve_hostname: False
hostname: {{ inventory_hostname }}
fqdn: {{ inventory_hostname }}

# Remove cloud-init when finished with it
runcmd:
  - [ yum, -y, remove, cloud-init ]
{% if gateway is defined %}
  - echo "GATEWAY={{ gateway }}" >> /etc/sysconfig/network
{% endif %}
{% if dns is defined %}
  - echo "# Generated by ansible" > /etc/resolv.conf
{% for server in dns.servers %}
  - echo "nameserver {{ server }}" >> /etc/resolv.conf
{% endfor %}
  - echo "domain {{ domain }}" >> /etc/resolv.conf
{% endif %}
  - /etc/init.d/network restart
  - ifdown eth0
  - ifup eth0

# Configure where output will go
output:
  all: ">> /var/log/cloud-init.log"

{% if ssh_rsa is defined %}
# configure interaction with ssh server
ssh_svcname: ssh
ssh_deletekeys: True
ssh_genkeytypes: ['rsa', 'ecdsa']

# Install my public ssh key to the first user-defined user configured
# in cloud.cfg in the template (which is centos for CentOS cloud images)
ssh_authorized_keys:
{% for key in ssh_rsa.key %}
    - {{ key }}
{% endfor %}
{% endif %}
