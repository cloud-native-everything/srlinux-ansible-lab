---
# Creating Domains
#
    - name: List the Virtual Machine
      virt: command=list_vms
      register: virt_vms

    - name: Copy xml file to image folder for k8s instances
      template: src=k8s-worker.xml.j2 backup=no dest={{ kvm_images_location }}/{{ item.name }}.xml
      with_items: "{{ k8s_inst }}"
      when: item.name not in virt_vms.list_vms

    - name: Copy qcow2 file to image folder for k8s instances
      copy:
        remote_src: true
        src: "{{ k8s_qcow2_image }}"
        dest: "{{ kvm_images_location }}/{{ item.name }}.qcow2"
        owner: qemu
        group: qemu
        force: no
      with_items: "{{ k8s_inst }}"
      when: item.name not in virt_vms.list_vms

# Copying script to hypervisor and modify image

    - name: Check if the script disable-netmanager.sh exists and have permissions
      command: ls /tmp
      register: st
      changed_when: False

    - name: Copying script to hypervisor to remove NetworkManager
      template:
        src: disable-netmanager.sh.j2
        dest: '/tmp/disable-netmanager-{{ item.name }}.sh'
        mode: 0755
      with_items: "{{ k8s_inst }}"
      when:
        - 'item.name not in st.stdout' 

    - name: Copying ifcfg-eth template
      template: 
        src: ifcfg-eth0.j2 
        backup: no 
        dest: "/tmp/ifcfg-eth0.{{ item.name }}"
      with_items: "{{ k8s_inst }}"
      when:
        - 'item.name not in st.stdout' 

    - name: Run the script over the image to remove NetworkManager
      shell: "/tmp/disable-netmanager-{{ item.name }}.sh {{ kvm_images_location }}/{{ item.name }}.qcow2"
      with_items: "{{ k8s_inst }}"
      when:
        - 'item.name not in st.stdout' 


    - name: Define kvm domains for k8s instances
      virt: command=define
            xml="{{ lookup('template', 'k8s-worker.xml.j2') }}"
      with_items: "{{ k8s_inst }}"
      when: item.name not in virt_vms.list_vms
    
    - name: Start guest VM of k8s instances
      virt: name={{ item.name }}
            state=running
      with_items: "{{ k8s_inst }}"
